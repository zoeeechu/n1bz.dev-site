---
title: 'Killing Onedrive for good!'
date: '2023-08-22'
lastmod: '2023-08-22'
tags: ['Scripting', 'Windows', 'OneDrive', 'Powershell', 'Script Breakdown', 'Guide', 'Bloatware']
draft: false
summary: ' My Fight Against Microsoft Bloatware RAHHHHH '
images: ['/static/images/card.png']
---



## Introduction

While I was working at my tech job recently, I was tasked with setting up a heap of Surface Pros... yikes. 
Even worse, each one of them was already set up with all the Microsoft bloatware and I mean *ALL* of it.

The worst part? OneDrive. Not only did each of them have OneDrive, but they were all using different versions what the *FUCK!* 
At first, I thought, hey, I could just remove it with a simple script, but it wasn’t that easy *it’s never* that easy...

You see, the way Microsoft stores these versions is like this:

`C:\Program Files\Microsoft OneDrive\23.127.0618.0001\...`

See that string of numbers? That, my friends, is the version number. So I couldn’t just do a one-script-fits-all solution... right? 
WRONG. Of course I could I just had to do a little bit of tomfoolery, hehehe.

So here was my process. First, like any good programmer, I researched and found a script by TERRAOperative, which can be found [here](https://github.com/TERRAOperative/OneDrive-Uninstaller/tree/master). 
Seemed pretty capable, right? While it seemed like it at first glance, it didn’t get the full clean uninstall.

So I dug further and found that invoking the command `OneDriveSetup.exe /Uninstall` would get OneDrive to uninstall itself  
a full clean uninstall. The catch was that `OneDriveSetup.exe` was located within our nasty version path:

`C:\Program Files\Microsoft OneDrive\23.127.0618.0001\OneDriveSetup.exe`

To fix this, I got to work making a script. The plan of action was simple:

1. Test multiple paths to locate the `Microsoft OneDrive` installation. 
2. Identify folders containing version numbers from these paths. 
3. Invoke the `/Uninstall` command using these paths. 
4. Clean up registry keys and other leftovers.


## So lets get Cracking!

Firstly, we need to close OneDrive to make folder edits:

```
TASKKILL /F /IM OneDrive.exe
```

Next, we'll remove unnecessary registry entries for a clean installation. Credit goes to TERRAOperative for this step:

```
 REG Delete "HKEY_CLASSES_ROOT\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
 REG Delete "HKEY_CLASSES_ROOT\Wow6432Node\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f
 REG ADD "HKEY_CLASSES_ROOT\CLSID\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /v System.IsPinnedToNameSpaceTree /d "0" /t REG_DWORD /f
```

Now, let's store the paths to be checked in an array for future reference and then verify their existence:
```
 $p = 'Program Files'
 $o = 'Microsoft OneDrive'
  $pathsToCheck = @(
    "C:\Users\$env:username\AppData\Local\Microsoft\OneDrive\",
    "C:\${p}\${o}\"
  )

  foreach ($path in $pathsToCheck) {
    $resolvedPath = [System.IO.Path]::GetFullPath($path)
    if (Test-Path -Path $resolvedPath) {
      $folders = Get-ChildItem -Path $resolvedPath -Directory

    }
    else {
      Write-Host "OneDrive path '$resolvedPath' not found."
    }
  }
```
You might be wondering, hey Zoe, why is one of the paths so complicated  
`$p = 'Program Files' $o = 'Microsoft OneDrive' "C:\${p}\${o}\".` 

Because simply quoting the file path doesn't work Windows does not account for spaces properly. 
This was a somewhat janky fix, but ehhhhhh... I just needed the job done.

Back to the script, let's search the given paths for folders with version numbers using the `"^\d"` function:

```
 foreach ($folder in $folders) {
  if ($folder.Name -match "^\d") {
    
  }
 }
```

Now, let's construct the path, add OneDriveSetup.exe, and invoke the command:

```
 $command = Join-Path -Path $resolvedPath -ChildPath "${folder}\OneDriveSetup.exe"
 $arg = "/Uninstall"
 Start-Process -FilePath $command -ArgumentList $arg -Wait
```
And that's about it! A script that adapts no matter what version of OneDrive you're using it will *SMITE* it regardless! 
If we ever need to add any new file paths, we can just add them to the array.

You can find the final script [here](https://gist.github.com/zoeeechu/038e0c82550ce2a79e4d63aef11d5326). 
I added a bit of polish, that's all!

If you find this script helpful, please consider starring the repository it would mean a lot!


